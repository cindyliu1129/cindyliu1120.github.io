<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¢³æ¬Šä¿éšªèˆ‡ç¢³åƒ¹é¢¨éšªæ¨¡æ“¬å¹³å°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f3f6f8;
      color: #333;
    }
    header {
      background-color: #1c7c54;
      color: white;
      padding: 20px;
      text-align: center;
    }
    main {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 1em;
    }
    button {
      margin-top: 20px;
      background-color: #1c7c54;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 1em;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #249d72;
    }
    .result-block {
      background: #eef5f1;
      padding: 15px;
      border-left: 5px solid #27ae60;
      margin-top: 20px;
      line-height: 1.6em;
    }
    canvas {
      max-width: 100%;
      height: auto;
      margin-top: 20px;
    }
    .chart-title {
      margin-top: 30px;
      font-weight: bold;
      color: #1c7c54;
    }
  </style>
</head>
<body>

<header>
  <h1>ç¢³æ¬Šä¿éšªèˆ‡ç¢³åƒ¹é¢¨éšªæ¨¡æ“¬å¹³å°</h1>
</header>

<main>
  <section>
    <h2>ç‚ºä»€éº¼éœ€è¦ç¢³æ¬Šä¿éšªï¼Ÿ</h2>
    <p>
      éš¨è‘—å…¨çƒæ·¨é›¶ç¢³æ’æ”¿ç­–æ¨é€²ï¼Œä¼æ¥­ç¢³æ¬Šçš„è²¡å‹™é¢¨éšªé€æ¼¸å—åˆ°é—œæ³¨ã€‚ç‰¹åˆ¥æ˜¯è£½é€ æ¥­ï¼Œç¢³æ’ä½”å…¨åœ‹ç¸½é‡ç´„ <strong>50%</strong> ä»¥ä¸Šã€‚ç¢³åƒ¹çŸ­æœŸå…§æ³¢å‹•åŠ‡çƒˆï¼Œå¯èƒ½å°è‡´ç¢³æ¬Šè³‡ç”¢åƒ¹å€¼ç¸®æ°´ï¼Œå°ä¼æ¥­è²¡å ±é€ æˆè¡æ“Šã€‚é€éç¢³æ¬Šä¿éšªèˆ‡åƒ¹æ ¼é¢¨éšªç®¡ç†ï¼Œå¯æå‰å°æ²–ä¸‹è·Œé¢¨éšªï¼Œä¿éšœä¼æ¥­æ·¨é›¶è½‰å‹èˆ‡ ESG è©•ç´šã€‚
    </p>
  </section>

  <section>
    <h2>è¼¸å…¥åƒæ•¸</h2>
    <label for="quantity">è³¼è²·ç¢³æ¬Šæ•¸é‡ï¼ˆå…¬å™¸ï¼‰</label>
    <input type="number" id="quantity" value="10000" min="1" />

    <label for="duration">æŒæœ‰æœŸé–“ï¼ˆæœˆï¼‰</label>
    <select id="duration">
      <option value="3">3</option>
      <option value="6" selected>6</option>
      <option value="12">12</option>
    </select>

    <label for="industry">ç”¢æ¥­åˆ¥</label>
    <select id="industry">
      <option value="é›»å­æ¥­">é›»å­æ¥­</option>
      <option value="é‹¼éµæ¥­">é‹¼éµæ¥­</option>
      <option value="çŸ³åŒ–æ¥­">çŸ³åŒ–æ¥­</option>
      <option value="å…¶ä»–">å…¶ä»–è£½é€ æ¥­</option>
    </select>

    <label for="strikePrice">å¯æ¥å—æœ€ä½åƒ¹æ ¼ï¼ˆç†è³ åŸºæº–ï¼Œå…ƒ/å™¸ï¼‰</label>
    <input type="number" id="strikePrice" value="3000" min="1" />

    <button onclick="runSimulation()">é–‹å§‹æ¨¡æ“¬èˆ‡ä¿è²»è©¦ç®—</button>

    <div id="result" class="result-block" style="display:none;"></div>
  </section>

  <section>
    <h2 class="chart-title">åƒ¹æ ¼èµ°å‹¢æ¨¡æ“¬åœ–</h2>
    <canvas id="priceChart"></canvas>
  </section>
</main>

<script>
const SIMULATIONS = 300;
const TRADING_DAYS_IN_MONTH = 22;

function randn_bm() {
  let u = 0, v = 0;
  while(u === 0) u = Math.random();
  while(v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function simulatePath(S0, mu, sigma, days) {
  let prices = [S0];
  for (let t = 1; t <= days; t++) {
    let dt = 1/252;
    let drift = (mu - 0.5 * sigma * sigma) * dt;
    let diffusion = sigma * Math.sqrt(dt) * randn_bm();
    let nextPrice = prices[t-1] * Math.exp(drift + diffusion);
    prices.push(nextPrice);
  }
  return prices;
}

function runSimulation() {
  const quantity = Number(document.getElementById("quantity").value);
  const duration = Number(document.getElementById("duration").value);
  const strikePrice = Number(document.getElementById("strikePrice").value);
  const industry = document.getElementById("industry").value;

  const initialPrice = 3500;
  const days = duration * TRADING_DAYS_IN_MONTH;

  let mu = 0.02, sigma = 0.3;
  if (industry === "é‹¼éµæ¥­") sigma = 0.35;
  else if (industry === "çŸ³åŒ–æ¥­") sigma = 0.33;
  else if (industry === "é›»å­æ¥­") sigma = 0.28;

  let losses = [], breached = 0, paths = [];

  for (let i = 0; i < SIMULATIONS; i++) {
    const path = simulatePath(initialPrice, mu, sigma, days);
    paths.push(path);
    const minPrice = Math.min(...path);
    if (minPrice < strikePrice) {
      let loss = (strikePrice - minPrice) * quantity;
      losses.push(loss);
      breached++;
    } else {
      losses.push(0);
    }
  }

  const probability = (breached / SIMULATIONS * 100).toFixed(1);
  const expectedLoss = (losses.reduce((a,b) => a+b, 0) / SIMULATIONS).toFixed(0);
  const basePremium = expectedLoss * 1.05;
  const cappedPremium = (basePremium * 0.75).toFixed(0);
  const fixedPremium = (basePremium * 0.55).toFixed(0);

  // é¡¯ç¤ºçµæœ
  const resultBox = document.getElementById("result");
  resultBox.innerHTML = `
    ğŸ“‰ ç¢³åƒ¹è·Œç ´ä¿éšœåƒ¹æ ¼çš„æ©Ÿç‡ï¼š<strong>${probability}%</strong><br>
    ğŸ’¸ é æœŸå¹³å‡æå¤±ï¼š<strong>NTD ${Number(expectedLoss).toLocaleString()}</strong><br><br>
    ğŸ›¡ï¸ <strong>ä¿éšªæ–¹æ¡ˆå»ºè­°ï¼š</strong><br>
    ãƒ»åƒ¹æ ¼ä¸Šé™å”è­°ï¼š<strong>NTD ${Number(basePremium).toLocaleString()}</strong><br>
    ãƒ»å›ºå®šç†è³ å‹ï¼š<strong>NTD ${Number(fixedPremium).toLocaleString()}</strong><br>
    ãƒ»æ¯”ä¾‹ç†è³ å‹ï¼š<strong>NTD ${Number(cappedPremium).toLocaleString()}</strong><br><br>
    ğŸ¤– æ™ºèƒ½åˆç´„ç¤ºæ„ï¼šè‹¥ç¢³åƒ¹ä½æ–¼ NTD ${strikePrice}ï¼Œå°‡è‡ªå‹•å•Ÿå‹•ç†è³ æ©Ÿåˆ¶ã€‚
  `;
  resultBox.style.display = "block";

  // Chart rendering
  const ctx = document.getElementById("priceChart").getContext("2d");
  if (window.priceChartInstance) window.priceChartInstance.destroy();

  const datasets = paths.slice(0, 30).map(path => ({
    data: path,
    borderColor: 'rgba(46, 204, 113, 0.2)',
    borderWidth: 1,
    pointRadius: 0,
    fill: false,
    tension: 0.2
  }));

  datasets.push({
    label: "ç†è³ åŸºæº–ç·š",
    data: Array(days + 1).fill(strikePrice),
    borderColor: 'rgba(231, 76, 60, 1)',
    borderWidth: 2,
    borderDash: [5, 5],
    pointRadius: 0,
    fill: false,
  });

  window.priceChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({length: days + 1}, (_, i) => i),
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'ç¢³åƒ¹æ¨¡æ“¬èµ°å‹¢ï¼ˆå…ƒ/å™¸ï¼‰',
          font: { size: 18 }
        }
      },
      scales: {
        x: { display: true, title: { display: true, text: 'å¤©æ•¸' } },
        y: { display: true, title: { display: true, text: 'ç¢³åƒ¹ï¼ˆå…ƒï¼‰' } }
      }
    }
  });
}
</script>
</body>
</html>
