<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¢³åƒ¹é¢¨éšªè©¦ç®—èˆ‡ä¿è²»è¨ˆç®—å¹³å°</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap');

  body {
    font-family: "Noto Sans TC", sans-serif;
    margin: 20px;
    background: #f5f9f9;
    color: #2c3e50;
    line-height: 1.6;
  }
  h1, h2, h3 {
    color: #2c3e50;
    margin-bottom: 8px;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
  }
  input[type="number"], select {
    padding: 8px 10px;
    width: 240px;
    margin-top: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
    box-sizing: border-box;
    transition: border-color 0.3s ease;
  }
  input[type="number"]:focus, select:focus {
    outline: none;
    border-color: #27ae60;
    box-shadow: 0 0 5px #27ae60;
  }
  small {
    color: #555;
    font-size: 0.9em;
  }
  button {
    margin-top: 28px;
    padding: 12px 28px;
    background: #27ae60;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1.1em;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #2ecc71;
  }
  button:disabled {
    background: #a5d6a7;
    cursor: not-allowed;
  }
  .result, .intro, .esgNote {
    margin-top: 32px;
    background: white;
    padding: 22px 30px;
    border-radius: 8px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
  }
  canvas {
    max-width: 100%;
    height: 280px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 18px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px 12px;
    text-align: center;
  }
  th {
    background-color: #27ae60;
    color: white;
    font-weight: 700;
  }
  /* éŸ¿æ‡‰å¼ */
  @media (max-width: 600px) {
    input[type="number"], select {
      width: 100%;
    }
    button {
      width: 100%;
      padding: 14px 0;
    }
  }
</style>
</head>
<body>

<h1>ç¢³åƒ¹é¢¨éšªè©¦ç®—èˆ‡ä¿è²»è¨ˆç®—å¹³å°</h1>

<div class="intro">
  <h2>ç‚ºä»€éº¼éœ€è¦ç¢³æ¬Šä¿éšªï¼Ÿ</h2>
  <p>
    éš¨è‘—å…¨çƒæ·¨é›¶ç¢³æ’çš„æ¨é€²ï¼Œè£½é€ æ¥­æˆç‚ºå°ç£ç¢³æ’æ”¾çš„ä¸»è¦ä¾†æºï¼Œ2023å¹´å æ¯”é” <strong>50.78%</strong>ã€‚  
    ç¢³åƒ¹åœ¨çŸ­æœŸå…§æ³¢å‹•å¹…åº¦å¯èƒ½è¶…é <strong>30%</strong>ï¼Œä¼æ¥­è‹¥ç„¡é¢¨éšªä¿éšœï¼Œå°‡é¢è‡¨é‡å¤§è²¡å‹™æå¤±ã€‚  
    æœ¬å¹³å°é€é <strong>AI æ¨¡æ“¬</strong> èˆ‡ <strong>ä¿è²»è©¦ç®—</strong>ï¼Œå”åŠ©ä¼æ¥­é™ä½ç¢³åƒ¹æ³¢å‹•çš„è¡æ“Šï¼Œä¸¦å„ªåŒ– ESG è²¡å‹™è¦åŠƒã€‚
  </p>
</div>

<form id="riskForm" autocomplete="off" novalidate>
  <label for="quantity">è³¼è²·ç¢³æ¬Šæ•¸é‡ï¼ˆå™¸ï¼‰ï¼š
    <input type="number" id="quantity" min="1" value="10000" required aria-describedby="quantityHelp" />
    <small id="quantityHelp">è«‹è¼¸å…¥è³¼è²·ç¢³æ¬Šçš„æ•¸é‡ï¼ˆå™¸ï¼‰ï¼Œä¾‹å¦‚ 10000 å™¸</small>
  </label>

  <label for="duration">æŒæœ‰æœŸé–“ï¼ˆæœˆï¼‰ï¼š
    <select id="duration" required>
      <option value="3">3</option>
      <option value="6" selected>6</option>
      <option value="12">12</option>
    </select>
  </label>

  <label for="industry">è¡Œæ¥­åˆ¥ï¼š
    <select id="industry" required>
      <option value="é›»å­æ¥­">é›»å­æ¥­</option>
      <option value="é‹¼éµæ¥­">é‹¼éµæ¥­</option>
      <option value="çŸ³åŒ–æ¥­">çŸ³åŒ–æ¥­</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>
  </label>

  <label for="expectedPriceSelect">é æœŸè³¼è²·åƒ¹æ ¼ï¼ˆå…ƒ/å™¸ï¼‰ï¼š
    <select id="expectedPriceSelect" aria-describedby="expectedPriceHelp">
      <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
      <option value="3250" selected>å°ç£å¸‚å ´å¹³å‡ï¼ˆç´„ 3250 å…ƒ/å™¸ï¼‰</option>
      <option value="2800">ä¿å®ˆä¼°è¨ˆï¼ˆ2800 å…ƒ/å™¸ï¼‰</option>
      <option value="4000">é«˜é¢¨éšªé ä¼°ï¼ˆ4000 å…ƒ/å™¸ï¼‰</option>
    </select>
    <input type="number" id="expectedPrice" min="1" value="3250" required style="margin-top: 6px;" aria-describedby="expectedPriceHelp" />
    <small id="expectedPriceHelp">é¸æ“‡é è¨­åƒ¹æ ¼æˆ–è‡ªè¡Œè¼¸å…¥é æœŸè³¼è²·åƒ¹æ ¼ï¼ˆå…ƒ/å™¸ï¼‰</small>
  </label>

  <label for="strikePrice">å¯æ¥å—æœ€ä½åƒ¹æ ¼ï¼ˆç†è³ åŸºæº–ï¼Œå…ƒ/å™¸ï¼‰ï¼š
    <input type="number" id="strikePrice" min="1" value="2800" required />
    <small>ç•¶ç¢³åƒ¹è·Œç ´æ­¤åƒ¹æ ¼ï¼Œå•Ÿå‹•ç†è³ æ©Ÿåˆ¶</small>
  </label>

  <button type="submit" id="submitBtn">é–‹å§‹é¢¨éšªè©¦ç®—</button>
</form>

<div class="result" id="result" style="display:none;">
  <h2>æ¨¡æ“¬çµæœèˆ‡ä¿è²»è©¦ç®—</h2>

  <h3>å¸‚å ´åƒ¹æ ¼æ¨¡æ“¬ï¼ˆæŒæœ‰æœŸé–“åƒ¹æ ¼èµ°å‹¢ï¼‰</h3>
  <canvas id="marketPriceChart" aria-label="å¸‚å ´åƒ¹æ ¼æ¨¡æ“¬èµ°å‹¢åœ–" role="img"></canvas>

  <h3>ç¢³åƒ¹é¢¨éšªæ¨¡æ“¬è·¯å¾‘</h3>
  <canvas id="priceChart" aria-label="ç¢³åƒ¹é¢¨éšªæ¨¡æ“¬è·¯å¾‘åœ–" role="img"></canvas>

  <p><strong>ç¢³åƒ¹è·Œç ´ç†è³ åŸºæº–åƒ¹æ ¼çš„æ©Ÿç‡ï¼š</strong><span id="probability"></span>%</p>
  <p><strong>é æœŸå¹³å‡æå¤±ï¼š</strong>NTD <span id="expectedLoss"></span></p>

  <h3>ä¿è²»æ–¹æ¡ˆå»ºè­°</h3>
  <table>
      <thead>
        <tr><th>é¸æ“‡</th><th>ä¿éšªæ–¹æ¡ˆ</th><th>ç†è³ æ¢ä»¶</th><th>ä¿è²» (NTD)</th></th><th>é©åˆå°è±¡</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="radio" name="plan" value="ä¿åº•å‹"></td>
          <td>ä¿åº•å‹</td>
          <td>è·Œç ´åŸºæº–ç«‹å³ç†è³ </td>
          <td>NTD <span id="premiumBasic">-</span></td>
          <td>é‹¼éµã€æ°´æ³¥ç­‰é«˜ç¢³æ’</td>
        </tr>
        <tr>
          <td><input type="radio" name="plan" value="å€é–“å‹"></td>
          <td>å€é–“å‹</td>
          <td>è·Œå¹…é”ç‰¹å®šå€é–“</td>
          <td>NTD <span id="premiumInterval">-</span></td>
          <td>çŸ³åŒ–ã€åŒ–å·¥ç”¢æ¥­</td>
        </tr>
        <tr>
          <td><input type="radio" name="plan" value="æ¯”ä¾‹å‹"></td>
          <td>æ¯”ä¾‹å‹</td>
          <td>ä¾è·Œå¹…æ¯”ä¾‹ç†è³ </td>
          <td>NTD <span id="premiumProportional">-</span></td>
          <td>é›»å­æ¥­ç­‰é¡˜åˆ†æ“”é¢¨éšª</td>
        </tr>
      </tbody>
    </table>
  <button onclick="downloadPDF()" style="margin-top: 20px;">ğŸ“¥ ä¸‹è¼‰ PDF å ±å‘Š</button>
	<button id="btnSmart" class="alt">ğŸ“ æ™ºèƒ½ä¿å–®</button>
</div>

<div class="esgNote" id="esgNote" style="display:none;">
  <h3>ESG è²¡å‹™å½±éŸ¿æç¤º</h3>
  <p>
    æ ¹æ“š IEA æ¨¡å‹ï¼Œè‹¥å…¨çƒæ–¼ 2050 å¹´é”æˆæ·¨é›¶ç›®æ¨™ï¼š<br>
    é›»åŠ›ç”¢æ¥­çš„éš±æ€§ç¢³æˆæœ¬å°‡å¾ <strong>0.03%</strong> ä¸Šå‡è‡³ <strong>18.4%</strong>ï¼›<br>
    å¤©ç„¶æ°£å¾ <strong>0.02%</strong> ä¸Šå‡è‡³ <strong>17.26%</strong>ï¼›<br>
    ç‡ƒç…¤ã€åŒ–å­¸å“ã€ç¤¦è£½å“ç­‰äº¦æœ‰é¡ä¼¼æƒ…æ³ã€‚<br><br>
    ğŸ‘‰ è‹¥æœªé€²è¡Œç¢³æ¬Šé¢¨éšªç®¡ç†ï¼Œä¼æ¥­ ESG è©•ç´šèˆ‡åœ‹éš›ä¾›æ‡‰éˆç«¶çˆ­åŠ›å°‡é¢è‡¨åš´é‡æŒ‘æˆ°ã€‚
  </p>
</div>

<script>
  const SIMULATIONS = 1000;
  const TRADING_DAYS_IN_MONTH = 22;

  // ç”¢ç”Ÿæ¨™æº–å¸¸æ…‹åˆ†ä½ˆæ•¸å€¼ (Box-Muller è®Šæ›)
  function randn_bm() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
  }

  // æ¨¡æ“¬å–®ä¸€è·¯å¾‘å¸‚å ´åƒ¹æ ¼èµ°å‹¢ (å¹¾ä½•å¸ƒæœ—é‹å‹•)
  function simulateMarketPrice(S0, mu, sigma, T_days) {
    let prices = [S0];
    const dt = 1/252;
    for(let t=1; t<=T_days; t++) {
      let drift = (mu - 0.5 * sigma * sigma) * dt;
      let diffusion = sigma * Math.sqrt(dt) * randn_bm();
      let nextPrice = prices[t-1] * Math.exp(drift + diffusion);
      prices.push(nextPrice);
    }
    return prices;
  }

  // è’™åœ°å¡ç¾…æ¨¡æ“¬å¤šè·¯å¾‘åƒ¹æ ¼ï¼Œè¨ˆç®—æ©Ÿç‡èˆ‡æå¤±
  function monteCarloSim(S0, mu, sigma, T_months, strike, quantity) {
    const T = T_months * TRADING_DAYS_IN_MONTH;
    let belowStrikeCount = 0;
    let losses = [];
    let pricePaths = [];

    for(let sim=0; sim < SIMULATIONS; sim++) {
      let prices = [S0];
      for(let t=1; t<=T; t++) {
        let dt = 1/252;
        let drift = (mu - 0.5 * sigma * sigma) * dt;
        let diffusion = sigma * Math.sqrt(dt) * randn_bm();
        let nextPrice = prices[t-1] * Math.exp(drift + diffusion);
        prices.push(nextPrice);
      }
      pricePaths.push(prices);

      // æå¤± = max(0, strike - æŒæœ‰æœŸæœ«åƒ¹æ ¼) * æ•¸é‡
      let endPrice = prices[prices.length - 1];
      if(endPrice < strike) belowStrikeCount++;
      losses.push(Math.max(0, strike - endPrice) * quantity);
    }

    const prob = (belowStrikeCount / SIMULATIONS * 100).toFixed(2);
    const avgLoss = (losses.reduce((a,b)=>a+b,0) / SIMULATIONS).toFixed(2);

    return {probability: prob, expectedLoss: avgLoss, pricePaths};
  }

  // Chart.js ç¹ªåœ–
  let priceChart, marketPriceChart;

  function plotPriceChart(paths) {
    const labels = [...Array(paths[0].length).keys()].map(d => `Day ${d}`);
    const datasets = [];

    // åªå–å‰10æ¢è·¯å¾‘ç•«ç·šï¼Œé¿å…åœ–è¡¨éäº‚
    for(let i=0; i<Math.min(10, paths.length); i++) {
      datasets.push({
        label: `æ¨¡æ“¬è·¯å¾‘${i+1}`,
        data: paths[i],
        borderColor: `rgba(46, 204, 113, ${0.2 + i*0.07})`,
        fill: false,
        tension: 0.1,
        pointRadius: 0
      });
    }

    if(priceChart) {
      priceChart.destroy();
    }

    const ctx = document.getElementById('priceChart').getContext('2d');
    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, position: 'top' },
          title: {
            display: true,
            text: 'ç¢³åƒ¹é¢¨éšªæ¨¡æ“¬è·¯å¾‘'
          }
        },
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  }

  function plotMarketPriceChart(S0, mu, sigma, T_months) {
    const T = T_months * TRADING_DAYS_IN_MONTH;
    const labels = [...Array(T+1).keys()].map(d => `Day ${d}`);
    const prices = simulateMarketPrice(S0, mu, sigma, T);

    if(marketPriceChart) {
      marketPriceChart.destroy();
    }

    const ctx = document.getElementById('marketPriceChart').getContext('2d');
    marketPriceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'å¸‚å ´åƒ¹æ ¼æ¨¡æ“¬',
          data: prices,
          borderColor: 'rgba(52, 152, 219, 0.7)',
          fill: false,
          tension: 0.1,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          title: { display: false }
        },
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  }

  // ä¿è²»è¨ˆç®—ï¼ˆç°¡åŒ–ç¤ºç¯„ï¼‰
  function calculatePremiums(expectedLoss) {
    // åŸºæœ¬æ–¹æ¡ˆæ”¶å– 15% é æœŸæå¤±ä½œç‚ºä¿è²»
    // å€é–“å‹æ–¹æ¡ˆæ”¶å– 12%
    // æ¯”ä¾‹å‹æ–¹æ¡ˆæ”¶å– 10%
    return {
      premiumBasic: (expectedLoss * 0.15).toFixed(2),
      premiumInterval: (expectedLoss * 0.12).toFixed(2),
      premiumProportional: (expectedLoss * 0.10).toFixed(2)
    };
  }

  // è¡¨å–®å…ƒç´ ç¶å®š
  const form = document.getElementById('riskForm');
  const resultDiv = document.getElementById('result');
  const probabilityEl = document.getElementById('probability');
  const expectedLossEl = document.getElementById('expectedLoss');
  const premiumBasicEl = document.getElementById('premiumBasic');
  const premiumIntervalEl = document.getElementById('premiumInterval');
  const premiumProportionalEl = document.getElementById('premiumProportional');

  const quantityInput = document.getElementById('quantity');
  const durationSelect = document.getElementById('duration');
  const expectedPriceInput = document.getElementById('expectedPrice');
  const expectedPriceSelect = document.getElementById('expectedPriceSelect');
  const strikePriceInput = document.getElementById('strikePrice');

  expectedPriceSelect.addEventListener('change', () => {
    if (expectedPriceSelect.value === 'custom') {
      expectedPriceInput.disabled = false;
      expectedPriceInput.value = '';
      expectedPriceInput.focus();
    } else {
      expectedPriceInput.disabled = true;
      expectedPriceInput.value = expectedPriceSelect.value;
    }
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    // ç°¡å–®é©—è­‰
    const quantity = Number(quantityInput.value);
    const duration = Number(durationSelect.value);
    const expectedPrice = Number(expectedPriceInput.value);
    const strikePrice = Number(strikePriceInput.value);

    if (isNaN(quantity) || quantity <= 0) {
      alert('è«‹è¼¸å…¥æ­£ç¢ºçš„è³¼è²·ç¢³æ¬Šæ•¸é‡');
      return;
    }
    if (isNaN(duration) || duration <= 0) {
      alert('è«‹é¸æ“‡æŒæœ‰æœŸé–“');
      return;
    }
    if (isNaN(expectedPrice) || expectedPrice <= 0) {
      alert('è«‹è¼¸å…¥æ­£ç¢ºçš„é æœŸè³¼è²·åƒ¹æ ¼');
      return;
    }
    if (isNaN(strikePrice) || strikePrice <= 0) {
      alert('è«‹è¼¸å…¥æ­£ç¢ºçš„ç†è³ åŸºæº–åƒ¹æ ¼');
      return;
    }
    if (strikePrice > expectedPrice) {
      alert('ç†è³ åŸºæº–åƒ¹æ ¼ä¸å¯é«˜æ–¼é æœŸè³¼è²·åƒ¹æ ¼');
      return;
    }

    // ç°¡å–®å¸‚å ´åƒæ•¸è¨­å®šï¼ˆå¯å†ä¾è¡Œæ¥­èª¿æ•´ï¼‰
    const mu = 0.05; // é æœŸå¹´åŒ–å ±é…¬ç‡ç´„5%
    const sigma = 0.3; // å¹´åŒ–æ³¢å‹•ç‡30%

    // è’™åœ°å¡ç¾…æ¨¡æ“¬
    const simResult = monteCarloSim(expectedPrice, mu, sigma, duration, strikePrice, quantity);

    // é¡¯ç¤ºçµæœ
    probabilityEl.textContent = simResult.probability;
    expectedLossEl.textContent = simResult.expectedLoss;

    const premiums = calculatePremiums(simResult.expectedLoss);
    premiumBasicEl.textContent = premiums.premiumBasic;
    premiumIntervalEl.textContent = premiums.premiumInterval;
    premiumProportionalEl.textContent = premiums.premiumProportional;

    // ç¹ªåœ–
    plotPriceChart(simResult.pricePaths);
    plotMarketPriceChart(expectedPrice, mu, sigma, duration);

    resultDiv.style.display = 'block';

    // æ»¾å‹•åˆ°çµæœå€å¡Š
    resultDiv.scrollIntoView({behavior: 'smooth'});
  });

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const report = document.getElementById("result");

    const canvas = await html2canvas(report, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pdfWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
	const scaleFactor = 0.8
    if (imgHeight < pdfHeight) {
      pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
    } else {
      let heightLeft = imgHeight;
      let position = 0;

      while (heightLeft > 0) {
        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pdfHeight;
        position -= pdfHeight;
        if (heightLeft > 0) pdf.addPage();
      }
    }

    pdf.save("ç¢³åƒ¹é¢¨éšªå ±å‘Š.pdf");
  }
</script>

</body>
</html>
